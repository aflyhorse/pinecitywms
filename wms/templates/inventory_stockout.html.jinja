{% extends "base.html.jinja" %}
{% from 'bootstrap5/form.html' import render_field %}
{% block content %}
    <style>
        /* Style for readonly fields */
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            border-color: #ced4da;
            opacity: 0.8;
        }
    </style>
    <div class="container p-5 my-5 border">
        <h2>出库</h2>
        <form method="post" autocomplete="off" id="stockout-form">
            {{ form.csrf_token }}
            <div class="row mb-3">
                <div class="col-md-6">{{ render_field(form.warehouse) }}</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">{{ render_field(form.customer_type) }}</div>
                <div class="col-md-6">{{ render_field(form.customer) }}</div>
            </div>
            <datalist id="item-ids">
                {% for id, name, price, count in items %}<option value="{{ name }}">{{ name }}</option>{% endfor %}
            </datalist>
            <div id="items">
                {% for item_form in form.items %}
                    {{ item_form.csrf_token }}
                    <div class="item-form d-flex align-items-center">
                        <div class="flex-grow-1">{{ render_field(item_form.item_id, placeholder="输入或选择物品", autocomplete="off") }}</div>
                        <div class="flex-grow-1">{{ render_field(item_form.stock_count, class="readonly-field") }}</div>
                        <div class="flex-grow-1">{{ render_field(item_form.quantity) }}</div>
                        <div class="flex-grow-1">{{ render_field(item_form.price, class="readonly-field") }}</div>
                        <button type="button" class="btn btn-danger remove-item">x</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-primary" id="add-item">添加物品</button>
            {{ render_field(form.submit) }}
        </form>
    </div>
{% endblock content %}
{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addItemButton = document.getElementById('add-item');
            const itemsDiv = document.getElementById('items');
            const customerTypeSelect = document.querySelector('[name="customer_type"]');
            const customerSelect = document.querySelector('[name="customer"]');
            const warehouseSelect = document.querySelector('[name="warehouse"]');
            const stockoutForm = document.getElementById('stockout-form');

            // Store the customers data grouped by type
            const customersByType = {
                {% for type_name, customers in customers_by_type.items() %}
                    '{{ type_name }}': [
                        {% for cust in customers %}
                            {
                                id: {{ cust.id }},
                                name: '{{ cust.name }}'
                            }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ]{% if not loop.last %},{% endif %}
                {% endfor %}
            };

            // Handle customer type change
            customerTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                const customers = customersByType[selectedType] || [];

                // Update customer select options
                customerSelect.innerHTML = '';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    customerSelect.appendChild(option);
                });
            });

            // Handle warehouse change - create a dedicated action for warehouse changes
            warehouseSelect.addEventListener('change', function() {
                // Redirect to the stockout page with the selected warehouse as a parameter
                const selectedWarehouse = this.value;
                window.location.href = `{{ url_for('stockout') }}?warehouse=${selectedWarehouse}`;
            });

            // Trigger initial customer list update
            customerTypeSelect.dispatchEvent(new Event('change'));

            // Handle adding new item
            addItemButton.addEventListener('click', function() {
                const template = document.querySelector('.item-form');
                if (template) {
                    const clone = template.cloneNode(true);
                    clone.querySelectorAll('input').forEach(input => {
                        input.value = '';
                        // Ensure autocomplete is off for newly added item inputs
                        if (input.name && input.name.endsWith('item_id')) {
                            input.setAttribute('autocomplete', 'off');
                        }
                        // Ensure readonly styling is applied
                        if (input.hasAttribute('readonly')) {
                            input.classList.add('readonly-field');
                        }
                    });
                    itemsDiv.appendChild(clone);
                }
            });

            // Handle removing item
            itemsDiv.addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-item')) {
                    const itemForms = document.querySelectorAll('.item-form');
                    if (itemForms.length > 1) {
                        event.target.closest('.item-form').remove();
                    }
                }
            });

            // Create a mapping of item names to IDs, prices and stock counts
            const itemNameMapping = {};
            const itemPrices = {};
            const itemCounts = {};
            {% for id, name, price, count in items %}
                itemNameMapping['{{ name }}'] = {{ id }};
                itemPrices[{{ id }}] = {{ price }};
                itemCounts[{{ id }}] = {{ count }};
            {% endfor %}

            // Store the original items array for searching
            const items = [
                {% for id, name, price, count in items %}
                    {
                        id: {{ id }},
                        name: '{{ name }}',
                        price: {{ price }},
                        count: {{ count }}
                    }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];

            // Handle item search, selection, and auto-fill for price and stock count
            itemsDiv.addEventListener('input', function(event) {
                const input = event.target;
                if (input.name && input.name.endsWith('item_id')) {
                    // Get the item form container
                    const itemForm = input.closest('.item-form');
                    const priceInput = itemForm.querySelector('[name$="price"]');
                    const stockCountInput = itemForm.querySelector('[name$="stock_count"]');

                    // If exact match found, set the price and stock count
                    const itemId = itemNameMapping[input.value];
                    if (itemId) {
                        priceInput.value = itemPrices[itemId].toFixed(2);
                        stockCountInput.value = itemCounts[itemId];
                        
                        // Highlight the readonly fields briefly to show they've been updated
                        [priceInput, stockCountInput].forEach(field => {
                            field.style.transition = 'background-color 0.3s';
                            field.style.backgroundColor = '#d1ecf1';
                            setTimeout(() => {
                                field.style.backgroundColor = '';
                            }, 500);
                        });
                        
                        return;
                    }

                    // Update datalist options based on input
                    const datalist = document.getElementById('item-ids');
                    datalist.innerHTML = '';

                    const searchTerm = input.value.toLowerCase();
                    const matches = items.filter(item =>
                        item.name.toLowerCase().includes(searchTerm)
                    );

                    matches.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        datalist.appendChild(option);
                    });
                }
            });

            // Store selected item's ID in the form before submission
            stockoutForm.addEventListener('submit', function(event) {
                const itemInputs = document.querySelectorAll('[name$="item_id"]');
                let hasError = false;

                for (let input of itemInputs) {
                    const id = itemNameMapping[input.value];
                    if (id) {
                        input.value = id;
                    } else if (input.value) {
                        hasError = true;
                    }
                }

                if (hasError) {
                    event.preventDefault();
                    alert('请从列表中选择有效的物品');
                }
            });
            
            // Disable browser autocomplete for all item input fields
            document.querySelectorAll('[name$="item_id"]').forEach(input => {
                input.setAttribute('autocomplete', 'off');
            });

            // Apply visual readonly styling to readonly fields
            document.querySelectorAll('input[readonly]').forEach(input => {
                input.classList.add('readonly-field');
            });
        });
    </script>
{% endblock scripts %}
