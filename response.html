

<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="description" content="青松城设备科仓库管理系统 - 用于管理设备和物品的仓库管理系统">
            <meta name="keywords" content="仓库管理,设备管理,物品管理,青松城,设备科">
            
                <link rel="stylesheet" href="/bootstrap/static/css/bootstrap.min.css">
            
            <title>青松城设备科仓库管理系统</title>
        
    </head>
    <body>
        

    
        <div class="alert alert-success" role="alert">
    
           登录成功。
        </div>
        <nav class="navbar navbar-expand-sm bg-light">
            <div class="container-fluid">
                <div class="d-flex justify-content-start">
                    <ul class="navbar-nav">
                        
    
    
    <a class="nav-item nav-link"
       href="/">
        青松城设备科仓库管理系统 
    </a>
    

                        
                            
    
    
    <a class="nav-item nav-link"
       href="/inventory">
        库存管理 
    </a>
    

                            
    
    
    <a class="nav-item nav-link"
       href="/records">
        操作记录 
    </a>
    

                            
                                
    
    
    <a class="nav-item nav-link"
       href="/item">
        物品管理 
    </a>
    

                                
    
    
    <a class="nav-item nav-link"
       href="/statistics_fee">
        费用统计 
    </a>
    

                            
                        
                    </ul>
                </div>
                
                    <div class="d-flex justify-content-end">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link">你好，Test Admin</a>
                            </li>
                            
    
    
    <a class="nav-item nav-link"
       href="/logout">
        登出 
    </a>
    

                        </ul>
                    </div>
                
            </div>
        </nav>
        
    <style>
        /* Style for readonly fields */
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            border-color: #ced4da;
            opacity: 0.8;
        }
    </style>
    <div class="container p-5 my-5 border">
        <h2>出库</h2>
        <form method="post" autocomplete="off" id="stockout-form">
            
            <div class="row mb-3">
                <div class="col-md-6">

    
    
        
    

    

    
    
    
    
    

    <div class="mb-3 required"><label class="form-label" for="warehouse">仓库</label>
                        <select class="form-select" id="warehouse" name="warehouse" required><option selected value="1">Test Warehouse</option></select>
                    
        </div>
    
</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">

    
    
        
    

    

    
    
    
    
    

    <div class="mb-3 required"><label class="form-label" for="area">区域</label>
                        <select class="form-select is-invalid" id="area" name="area" required></select>
                    
                        <div class="invalid-feedback d-block">Not a valid choice.</div>
        </div>
    
</div>
                <div class="col-md-6">

    
    
        
    

    

    
    
    
    
    

    <div class="mb-3 required"><label class="form-label" for="department">部门</label>
                        <select class="form-select is-invalid" id="department" name="department" required></select>
                    
                        <div class="invalid-feedback d-block">Not a valid choice.</div>
        </div>
    
</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">

    
    
        
    

    

    
    
    
    
    

    <div class="mb-3 required"><label class="form-label" for="location">具体地点</label>
                        <input class="form-control" id="location" maxlength="30" minlength="1" name="location" required type="text" value="测试地点">
                    
        </div>
    
</div>
            </div>
            <datalist id="item-ids">
                
            </datalist>
            <div id="items">
                
                    
                    <div class="item-form d-flex align-items-center">
                        <div class="flex-grow-1">

    
    
        
    

    

    
    
    
    
    

    <div class="mb-3 required"><label class="form-label" for="items-0-item_id">物品</label>
                        <input autocomplete="off" class="form-control" id="items-0-item_id" list="item-ids" name="items-0-item_id" placeholder="输入或双击选择物品" required type="text" value="1">
                    
        </div>
    
</div>
                        <div class="flex-grow-1">

    
    

    

    
    
    
    
        
        
        
        
    
    

    <div class="mb-3"><label class="form-label" for="items-0-stock_count">库存数量</label>
                        <input class="form-control readonly-field" id="items-0-stock_count" name="items-0-stock_count" readonly type="number" value="">
                    
        </div>
    
</div>
                        <div class="flex-grow-1">

    
    
        
    

    

    
    
    
    
    

    <div class="mb-3 required"><label class="form-label" for="items-0-quantity">数量</label>
                        <input class="form-control" id="items-0-quantity" name="items-0-quantity" required type="number" value="5">
                    
        </div>
    
</div>
                        <div class="flex-grow-1">

    
    
        
    

    

    
    
    
    
        
        
        
        
    
    

    <div class="mb-3 required"><label class="form-label" for="items-0-price">价格</label>
                        <input class="form-control readonly-field" id="items-0-price" name="items-0-price" readonly required step="any" type="number" value="60.00">
                    
        </div>
    
</div>
                        <button type="button" class="btn btn-danger remove-item">x</button>
                    </div>
                
            </div>
            <button type="button" class="btn btn-primary" id="add-item">添加物品</button>
            

    
    

    

    
    
    
    
    

    
        
        
        
    

            
            
            <input class="btn btn-primary btn-md" id="submit" name="submit" type="submit" value="出库">
        




        </form>
    </div>

        
    
            <script src="/bootstrap/static/umd/popper.min.js"></script>
        <script src="/bootstrap/static/js/bootstrap.min.js"></script>
        
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addItemButton = document.getElementById('add-item');
            const itemsDiv = document.getElementById('items');
            const warehouseSelect = document.querySelector('[name="warehouse"]');
            const stockoutForm = document.getElementById('stockout-form');

            // Handle warehouse change - create a dedicated action for warehouse changes
            warehouseSelect.addEventListener('change', function() {
                // Redirect to the stockout page with the selected warehouse as a parameter
                const selectedWarehouse = this.value;
                window.location.href = `/stockout?warehouse=${selectedWarehouse}`;
            });

            // Handle adding new item
            addItemButton.addEventListener('click', function() {
                const template = document.querySelector('.item-form');
                if (template) {
                    const clone = template.cloneNode(true);
                    clone.querySelectorAll('input').forEach(input => {
                        input.value = '';
                        // Ensure autocomplete is off for newly added item inputs
                        if (input.name && input.name.endsWith('item_id')) {
                            input.setAttribute('autocomplete', 'off');
                            // Add data attribute for original value
                            input.setAttribute('data-original-value', '');
                        }
                        // Ensure readonly styling is applied
                        if (input.hasAttribute('readonly')) {
                            input.classList.add('readonly-field');
                        }
                    });
                    itemsDiv.appendChild(clone);
                }
            });

            // Handle removing item
            itemsDiv.addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-item')) {
                    const itemForms = document.querySelectorAll('.item-form');
                    if (itemForms.length > 1) {
                        event.target.closest('.item-form').remove();
                    }
                }
            });

            // Create a mapping of item names to IDs, prices and stock counts
            const itemNameMapping = {};
            const itemPrices = {};
            const itemCounts = {};
            

            // Store the original items array for searching
            const items = [
                
            ];

            // Handle item search, selection, and auto-fill for price and stock count
            itemsDiv.addEventListener('input', function(event) {
                const input = event.target;
                if (input.name && input.name.endsWith('item_id')) {
                    // Get the item form container
                    const itemForm = input.closest('.item-form');
                    const priceInput = itemForm.querySelector('[name$="price"]');
                    const stockCountInput = itemForm.querySelector('[name$="stock_count"]');

                    // Store the original text input value for form submission
                    input.setAttribute('data-original-value', input.value);

                    // If exact match found, set the price and stock count
                    const itemId = itemNameMapping[input.value];
                    if (itemId) {
                        priceInput.value = itemPrices[itemId].toFixed(2);
                        stockCountInput.value = itemCounts[itemId];
                        input.setAttribute('data-item-id', itemId); // Store the matched ID
                        
                        // Highlight the readonly fields briefly to show they've been updated
                        [priceInput, stockCountInput].forEach(field => {
                            field.style.transition = 'background-color 0.3s';
                            field.style.backgroundColor = '#d1ecf1';
                            setTimeout(() => {
                                field.style.backgroundColor = '';
                            }, 500);
                        });
                        
                        return;
                    }

                    // Update datalist options based on input
                    const datalist = document.getElementById('item-ids');
                    datalist.innerHTML = '';

                    const searchTerm = input.value.toLowerCase();
                    const matches = items.filter(item =>
                        item.name.toLowerCase().includes(searchTerm)
                    );

                    matches.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        datalist.appendChild(option);
                    });
                }
            });

            // Store selected item's ID in the form before submission
            stockoutForm.addEventListener('submit', function(event) {
                const itemInputs = document.querySelectorAll('[name$="item_id"]');
                let hasError = false;

                for (let input of itemInputs) {
                    // Use the data-original-value to look up the ID
                    const originalValue = input.getAttribute('data-original-value') || input.value;
                    const itemId = itemNameMapping[originalValue];
                    
                    if (itemId) {
                        // Replace the display text with the actual item ID for form submission
                        input.value = itemId;
                    } else if (input.value) {
                        hasError = true;
                    }
                }

                if (hasError) {
                    event.preventDefault();
                    alert('请从列表中选择有效的物品');
                }
            });
            
            // Set initial data-original-value for existing fields
            document.querySelectorAll('[name$="item_id"]').forEach(input => {
                input.setAttribute('data-original-value', input.value);
                input.setAttribute('autocomplete', 'off');
            });

            // Apply visual readonly styling to readonly fields
            document.querySelectorAll('input[readonly]').forEach(input => {
                input.classList.add('readonly-field');
            });
        });
    </script>

    </body>
</html>